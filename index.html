<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Arkansas County DYS Heatmap</title>
    <style>
      body {
        margin: 0;
        background: #f9f9f9;
        font-family: sans-serif;
      }
      svg {
        display: block;
        margin: auto;
        width: 100vw;
        height: 100vh;
      }
      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 13px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .info-box {
        max-width: 500px;
        margin: 10px auto;
        background: #fff;
        border: 1px solid #ccc;
        padding: 15px;
        font-size: 14px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="tooltip" id="tooltip"></div>
    <div class="info-box" id="info-box"></div>
    <div id="svg-container"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module">
      import { countyData } from "./data/countyData-13.js";

      // ðŸ”¥ Now you can use countyData as usual
      console.log("Loaded counties:", Object.keys(countyData));

      // Calculate max commit rate to normalize coloring
      const allCommitRates = Object.values(countyData).map((d) => {
        const youth = d.age10_14.total + d.age15_19.total;
        const totalCommits = Object.values(d.Commits).reduce(
          (a, b) => a + b,
          0
        );
        return youth > 0 ? totalCommits / youth : 0;
      });
      const maxRate = d3.max(allCommitRates);

      const color = d3
        .scaleQuantize()
        .domain([0, maxRate])
        .range(d3.schemeReds[9]);

      const tooltip = d3.select("#tooltip");
      const infoBox = d3.select("#info-box");

      fetch("./data/COUNTY_BOUNDARY.svg")
        .then((response) => response.text())
        .then((svgText) => {
          document.getElementById("svg-container").innerHTML = svgText;

          Object.entries(countyData).forEach(([county, data]) => {
            const el = d3.select(`#${CSS.escape(county)}`);
            const youth = data.age10_14.total + data.age15_19.total;
            const totalCommits = Object.values(data.Commits).reduce(
              (a, b) => a + b,
              0
            );
            const rate = youth > 0 ? totalCommits / youth : 0;

            el.attr("fill", color(rate))
              .style("cursor", "pointer")
              .on("mousemove", (event) => {
                tooltip
                  .style("left", `${event.pageX + 10}px`)
                  .style("top", `${event.pageY - 20}px`)
                  .style("opacity", 1).html(`
                  <strong>${county}</strong><br/>
                  Population: ${data.pop.toLocaleString()}<br/>
                  Commits (5yr): ${totalCommits}<br/>
                  Per 1k Youth: ${(rate * 1000).toFixed(2)}
                `);
              })
              .on("mouseout", () => tooltip.style("opacity", 0))
              .on("click", () => {
                infoBox.style("display", "block").html(`
                  <h3>${county} County</h3>
                  <p><strong>Total Pop (Avg):</strong> ${data.pop.toLocaleString()}</p>
                  <p><strong>Ages 10â€“14:</strong> ${data.age10_14.total} (M: ${
                  data.age10_14.male
                }, F: ${data.age10_14.female})</p>
                  <p><strong>Ages 15â€“19:</strong> ${data.age15_19.total} (M: ${
                  data.age15_19.male
                }, F: ${data.age15_19.female})</p>
                  <p><strong>DYS Commitments:</strong></p>
                  <ul>
                    ${Object.entries(data.Commits)
                      .map(([yr, val]) => `<li>${yr}: ${val}</li>`)
                      .join("")}
                  </ul>
                  <p><strong>Per 1k Youth:</strong> ${(rate * 1000).toFixed(
                    2
                  )}</p>
                `);
              });
          });

          console.log("âœ… Map rendered with interactive county data");
        });
    </script>
  </body>
</html>
