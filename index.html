<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Arkansas County DHS-DYS Heatmap</title>
    <style>
      body {
        margin: 0;
        background: #f9f9f9;
        font-family: sans-serif;
      }
      svg {
        width: 100%;
        height: auto;
        display: block;
        max-width: 100%;
        max-height: 100%;
        transition: all 0.4s ease-in-out;
      }
      .app-header {
        background: linear-gradient(135deg, #1e3c72, #2a5294);
        color: white;
        text-align: center;
        padding: 5px 2px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: sticky;
        top: 0;
        z-index: 1001;
      }
      .app-header h1 {
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        font-size: 0.875em;
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.25);
      }
      .app-footer {
        border-top: 1px solid #ccc;
        padding: 20px 15px;
        text-align: center;
        font-size: 13px;
        color: #555;
        margin-top: 40px;
      }
      .app-footer a {
        color: #1e3c72;
        text-decoration: none;
        font-weight: 500;
      }
      .app-footer a:hover {
        text-decoration: underline;
        color: #2a5298;
      }
      .district-btn {
        background-color: #e0e0e0;
        color: #333;
        border: 1px solid #bbb;
        border-radius: 20px;
        padding: 6px 14px;
        margin: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .district-btn:hover {
        background-color: #c9c9c9;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      }
      .district-btn.selected {
        background-color: #333;
        color: #fff;
        border-color: #000;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
      }
      .district-btn.reset {
        background: #1976d2;
        color: #fff;
        font-weight: bold;
        border: none;
      }
      .district-btn.reset:hover {
        background: #125ea8;
      }
      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 13px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
      }
      #stats-bar {
        padding: 10px 20px;
        font-weight: bold;
        font-size: 14px;
        background: #f1f1f1;
        border-bottom: 1px solid #ccc;
      }
      #wrapper {
        padding: 10px;
        text-align: center;
        background: #fff;
        border-bottom: 1px solid #ccc;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      #stats-bar {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
      }
      #district-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .info-box {
        max-width: 500px;
        margin: 10px auto;
        background: #fff;
        border: 1px solid #ccc;
        padding: 15px;
        font-size: 14px;
        display: none;
      }
      .district-btn.selected {
        background: #555;
        color: #fff;
        border: 2px solid #000;
      }
      .faded {
        opacity: 0.25;
        transition: opacity 0.3s;
      }
      .top-bar {
        background: #fff;
        padding: 10px 20px;
        border-bottom: 1px solid #ccc;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
      }
      .main-layout {
        display: flex;
        height: calc(100vh - 100px); /* Accounting for header and top bar */
        overflow: hidden;
        position: relative;
      }
      #district-buttons {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        gap: 6px; /* space between buttons */
      }
      .left-panel {
        width: 120px;
        background: #f0f0f0;
        border-right: 1px solid #ccc;
        overflow-y: auto;
        flex-shrink: 0;
      }
      .left-panel button {
        margin: 4px 0;
        padding: 8px;
        border: none;
        border-radius: 6px;
        background: #eee;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
      }
      .left-panel button:hover {
        background: #ddd;
      }
      .left-panel .selected {
        background: #444;
        color: #fff;
      }
      .map-container {
        flex: 1;
        min-height: 0; /* Important for flex container */
        overflow: auto;
        position: relative;
      }
      #svg-container {
        width: 100%;
        height: 100%;
      }
      .right-panel {
        width: 300px;
        background: #fafafa;
        border-left: 1px solid #ccc;
        overflow-y: auto;
        flex-shrink: 0;
      }

      /* Responsive styles */
      @media (max-width: 768px) {
        .main-layout {
          flex-direction: column;
          height: auto;
          overflow: visible;
        }

        .left-panel {
          width: 100%;
          height: auto;
          border-right: none;
          border-bottom: 1px solid #ccc;
        }

        .map-container {
          height: 70vh;
          width: 100%;
          overflow: visible;
        }

        /* Mobile SVG styles */
        svg {
          width: 100%;
          height: 100%;
          object-fit: contain;
          display: block;
          margin: 0 auto;
          padding: 10px;
          max-height: 65vh; /* Slightly less than container height */
          transform-origin: center center;
          transform: scale(
            0.95
          ); /* Slightly scaled down to ensure visibility */
        }

        .right-panel {
          width: 100%;
          border-left: none;
          border-top: 1px solid #ccc;
        }

        #district-buttons {
          display: flex;
          flex-direction: row;
          flex-wrap: wrap;
          justify-content: center;
          padding: 0;
        }

        #district-buttons button {
          margin: 5px;
          padding: 5px;
          border: 1px orange solid;
        }
      }
    </style>
    <script>
      const cacheBust = `?v=${Date.now()}`;

      const script = document.createElement("script");
      script.type = "module";
      script.src = `./data/countyData-13.js${cacheBust}`;
      document.body.appendChild(script);

      // For SVG fetch
      const originalFetch = window.fetch;
      window.fetch = function (resource, init) {
        if (typeof resource === "string" && resource.endsWith(".svg")) {
          resource += cacheBust;
        }
        return originalFetch(resource, init);
      };
    </script>
  </head>
  <body>
    <header class="app-header">
      <h1>Juvenile Justice Information Dashboard</h1>
    </header>
    <div class="top-bar" id="stats-bar">
      Show: All Districts | Total Commits: — | Per 1k Youth: —
    </div>

    <div class="main-layout">
      <div class="left-panel">
        <div id="district-buttons"></div>
      </div>
      <div class="map-container">
        <div id="svg-container"></div>
      </div>
      <div class="right-panel">
        <div class="info-box" id="info-box"></div>
      </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module">
      function updateStatsBar(district) {
        const statsBar = document.getElementById("stats-bar");

        if (!district) {
          statsBar.innerHTML = `Show: All Districts | Total Commits: — | Per 1k Youth: —`;
          return;
        }

        const filtered = Object.values(countyData).filter(
          (d) => d.district === district
        );

        const totalYouth = filtered.reduce(
          (sum, d) => sum + d.age10_14.total + d.age15_19.total,
          0
        );

        const totalCommits = filtered.reduce(
          (sum, d) => sum + Object.values(d.Commits).reduce((a, b) => a + b, 0),
          0
        );

        const per1k = totalYouth > 0 ? (totalCommits / totalYouth) * 1000 : 0;

        statsBar.innerHTML = `Show: District ${district} | Total Commits: ${totalCommits} | Per 1k Youth: ${per1k.toFixed(
          2
        )}`;
      }

      function highlightDistrict(selectedDistrict) {
        Object.entries(countyData).forEach(([county, data]) => {
          const el = d3.select(`#${CSS.escape(county)}`);
          const youth = data.age10_14.total + data.age15_19.total;
          const commits = Object.values(data.Commits).reduce(
            (a, b) => a + b,
            0
          );
          const rate = youth > 0 ? commits / youth : 0;

          if (!el.empty()) {
            if (
              selectedDistrict === null ||
              data.district === selectedDistrict
            ) {
              el.attr("fill", color(rate))
                .attr("data-color", color(rate))
                .classed("faded", false) // REMOVE faded
                .style("opacity", 1.9);
            } else {
              el.classed("faded", true); // ADD faded to others
            }
          }
        });

        tooltip.style("opacity", 0);
        infoBox.style("display", "none");
        updateStatsBar(selectedDistrict);
      }

      import { countyData } from "./data/countyData-13.js?v=3";

      const uniqueDistricts = Array.from(
        new Set(Object.values(countyData).map((d) => d.district))
      ).sort((a, b) => {
        const numA = parseInt(a);
        const numB = parseInt(b);

        if (!isNaN(numA) && !isNaN(numB)) {
          return numA - numB;
        }
        return a.localeCompare(b);
      });

      // 🔥 Now you can use countyData as usual
      console.log("Loaded counties:", Object.keys(countyData));

      // Calculate max commit rate to normalize coloring
      const allCommitRates = Object.values(countyData).map((d) => {
        const youth = d.age10_14.total + d.age15_19.total;
        const totalCommits = Object.values(d.Commits).reduce(
          (a, b) => a + b,
          0
        );
        return youth > 0 ? totalCommits / youth : 0;
      });
      const maxRate = d3.max(allCommitRates);

      const color = d3
        .scaleQuantize()
        .domain([0, maxRate])
        .range(d3.schemeReds[9]);

      const tooltip = d3.select("#tooltip");
      const infoBox = d3.select("#info-box");

      fetch("./data/COUNTY_BOUNDARY.svg")
        .then((response) => response.text())
        .then((svgText) => {
          document.getElementById("svg-container").innerHTML = svgText;

          Object.entries(countyData).forEach(([county, data]) => {
            const el = d3.select(`#${CSS.escape(county)}`);
            const youth = data.age10_14.total + data.age15_19.total;
            const totalCommits = Object.values(data.Commits).reduce(
              (a, b) => a + b,
              0
            );
            const rate = youth > 0 ? totalCommits / youth : 0;

            el.attr("fill", color(rate))
              .style("cursor", "pointer")
              .on("mousemove", (event) => {
                tooltip
                  .style("left", `${event.pageX + 10}px`)
                  .style("top", `${event.pageY - 20}px`)
                  .style("opacity", 1).html(`
                  <strong>${county}</strong><br/>
                  Population: ${data.pop.toLocaleString()}<br/>
                  Commits (5yr): ${totalCommits}<br/>
                  Per 1k Youth: ${(rate * 1000).toFixed(2)}
                `);
              })
              .on("mouseout", () => tooltip.style("opacity", 0))
              .on("click", () => {
                infoBox.style("display", "block").html(`
                  <h3>${county} County</h3>
                  <p><strong>Total Pop (Avg):</strong> ${data.pop.toLocaleString()}</p>
                  <p><strong>Ages 10–14:</strong> ${data.age10_14.total} (M: ${
                  data.age10_14.male
                }, F: ${data.age10_14.female})</p>
                  <p><strong>Ages 15–19:</strong> ${data.age15_19.total} (M: ${
                  data.age15_19.male
                }, F: ${data.age15_19.female})</p>
                  <p><strong>DYS Commitments:</strong></p>
                  <ul>
                    ${Object.entries(data.Commits)
                      .map(([yr, val]) => `<li>${yr}: ${val}</li>`)
                      .join("")}
                  </ul>
                  <p><strong>Per 1k Youth:</strong> ${(rate * 1000).toFixed(
                    2
                  )}</p>
                `);
              });
          });

          console.log("✅ Map rendered with interactive county data");

          const districtBtnContainer =
            document.getElementById("district-buttons");

          uniqueDistricts.forEach((district) => {
            const btn = document.createElement("button");
            btn.textContent = district;
            btn.addEventListener("click", () => highlightDistrict(district));
            districtBtnContainer.appendChild(btn);
          });

          const resetBtn = document.createElement("button");
          resetBtn.textContent = "Reset";
          resetBtn.addEventListener("click", () => {
            highlightDistrict(null);
            updateStatsBar(null);
            location.reload();
          });
          districtBtnContainer.prepend(resetBtn);

          document.getElementById("district-buttons").prepend(resetBtn);
        });
    </script>
    <footer class="app-footer">
      <p>
        Built with ❤️ using open data from the
        <a
          href="https://gis.arkansas.gov/product/county-boundary-polygons/"
          target="_blank"
          rel="noopener"
          >Arkansas GIS Office</a
        >
        and
        <a
          href="https://www.census.gov/data/tables/time-series/demo/popest/2020s-counties-detail.html"
          target="_blank"
          rel="noopener"
          >U.S. Census Bureau</a
        >.
      </p>
      <p>
        View source on
        <a
          href="https://github.com/dariansweb/arkansas-county-map"
          target="_blank"
          rel="noopener"
          >GitHub</a
        >
        — contributions welcome!
      </p>
    </footer>
  </body>
</html>
